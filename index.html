<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Welcome to Kenta & Mariko Bridal</title>
	<link rel="stylesheet" href="index.css">
</head>
<body class="double">

<div id="top_logo">
	<img src="./KentaMarikoBridalLogo1.png" width="100%"/>
</div>

<!-- 結婚式翌日に有効化するアルバム
<a href="https://photos.app.goo.gl/NdoDAPi37TYJEzdh7">アルバムへのリンク</a>
-->

<!--<p id="welcome"></p>-->
<div id="welcome">
	<img id="welcome_gif" src="./kenta_Welcome.gif"  width="100%"/>
</div>


<style>
	/* チャット画面を囲むdiv要素のスタイル */
    #konnect-container {
      //opacity: 0; // ページ読み込み時に一瞬表示される小窓を抑止するため 
      right: 5px;
      bottom: 40px; // !important無指定  
      width: 498px!important; /* 横幅500から左右border分2pxマイナス */
      max-height: calc(100% - 40px)!important; // 画面高さ - 下部ボタン高さ - 画面上部との余白
    }
    
    
    /* ウェルカムモーションGifのdiv要素 */
    #welcome {
	    //display: none;
	    position: fixed;
	    z-index: 100000;
	    width: calc(100% - 10px)!important;
		bottom: 5px;
		right: 5px;
		//height:330px;
		//width:30%;
		//height:30%;
		//
		//min-width: 385px; 
		//min-height: 82px; 
		//margin: 0;
		//background: url("./kenta_Welcome.gif") left top no-repeat;
		//background-position: right;
		//background-size: 375px 667px; 
		//background-repeat: no-repeat;
		cursor:pointer;
    }
    
    // ウェルカムモーションgifのimg要素
	#welcome_gif{
		width: 100%!important;
    	margin-left: 10px;
    	margin-right:10px;
	}
	
	
    /* 画面下部のボタン表示部のスタイル */
    #custom_btn_container {
      position: fixed;
      right: 5px;
      bottom: 0px;
      z-index: 99998; /* div#konnect-containerに設定されている値と同じ値を指定 */
      max-width: 498px!important; /* 横幅500から左右border分2pxマイナス */
      //width:498px;
      width: calc(100% - 12px);
	  height: 40px;
      border: 1px solid #DDDDDD;
      background-color: #EDF8E4;
      font-family: "Yu Gothic Medium", YuGothic, sans-serif;
      line-height: 40px;
    }
    /* 画面下部ボタンのスタイル */
    .square_btn1,.square_btn2,.square_btn3{
      display: inline-block;
      margin: 3px;
      //padding: .3em 1em;
      border-radius: 3px;
      box-sizing: border-box;
      color: #fff;
      font-size: 12px;
      line-height: 1.5;
      text-decoration: none;
      text-align: center;
      vertical-align: middle;
      transition: .4s;
    }.square_btn1:hover,.square_btn2:hover,.square_btn3:hover {
      background: #e28500;
    }
    	.square_btn1 {
		width: calc(40% - 6px);
		background: #84cb45;
	}
	
	.square_btn2 {
		width: calc(30% - 6px);
		background: #6BB6BB;
	}
	.square_btn3 {
		width: calc(30% - 6px );
		background: #6BB6BB;
	}
	
	#mbaGuestFrame_content_input_wrapper_textarea > span {
		 display: none !important;
	}
	
</style>
	
	
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script type="text/javascript" src="https://agent.chordship.global.fujitsu.com/assets/script/embed/current/mobi-agent-client-frame-loader.min.js"></script>

	
<script>
	
	'use strict';
	
	function countupCounter() {

            let target = `https://kentamarikohappywedding.azurewebsites.net/good`;
            $.ajax({
                url: target,
                data: 'json'
            })
            .done((res) => {
                console.log(res);
                
                var goodCount=res.good_count + '';
                
                $('#btn1').html("おめでとう！<br>"+ goodCount.substr(-4));
                
            });
	};
	
	function getCounter() {


            let target = `https://kentamarikohappywedding.azurewebsites.net/get`;
           
            $.ajax({
                url: target,
                data: 'json'
            })
            .done((res) => {
                console.log(res);
                
                var goodCount=res.good_count + '';
                
                $('#btn1').html("おめでとう！<br>"+ goodCount.substr(-4));
                
            });
	};
	
	 function showChatWindow() {
	      // 小窓の制御
	     $('#konnect-container').css({
	        'visibility': 'visible',
	        'opacity': '1.0',
	        'top': 'auto',
	        'bottom': ''
	      });
	      // 下部ボタンの制御
	      $('#custom_btn_container').show();
	      // 閉じるボタンの制御
	      setTimeout(function() {
	        $('#close_btn').css('display', 'block');
	      }, 500);
	      // バナーを閉じる
	      //$('#mobileBanner').fadeOut('normal');
		 
		
    };
    
    // チャット画面を隠す処理
     function hideChatWindow() {
		// 下部ボタンの制御
		$('#custom_btn_container').fadeOut(500);
		// 閉じるボタンの制御
		$('#close_btn').css('display', 'none');
		// 小窓の制御
		$('#konnect-container').animate({
		'opacity': '0'
		},{
		duration: 500,
		queue: false,
		complete: function() { // コールバック
		  $('#konnect-container').css({
		    'visibility': 'hidden',
		    'top': 'auto',
		    //'top': '200px',
		    //'bottom': '-' + $('#konnect-container').height() + 'px'
		    'bottom': ''
		  });
		  // バナー表示
		  $('#mobileBanner').fadeIn('normal');
		}
		});
    };
	// welcome画像をクリックした時の処理
	$('#welcome').on('click', function(){
		$('#welcome').css({
		    //'visibility': 'hidden',
		    'z-index':1,
		    'opacity': '0.0',
		    'transition' : 'opacity 1s linear 0s'
		});
		startChat();
		MobiAgentClient.toggle(true);
	});
	var startChat = function() {
	    var domainId = $('#domain-id').val();
	    localStorage.setItem('domain-id', domainId);
		
		
	    MobiAgentClient.init(
    		'https://agent.chordship.global.fujitsu.com', // server url
    		'fujitsudemo02',
			{
		        useMarkDownSyntax: true,
		        allowFileUpload: false,
		        skipDomainStatusCheck: true,
		        listenVisiblityChange: false,
		        showAvatar: true,
		        location: "KentaMarikoBridal"
			}, // options
			function(){
				// チャット画面の読み込み後、コールバックでボタンをappendする
			    $('#konnect-container').after('<div id="custom_btn_container" style="display:none"></div>');
			    $('#custom_btn_container').append('<a href="#" id="btn1" class="square_btn1">おめでとう</a>');
			    //$('#custom_btn_container').append('<a href="#" id="good_count" class="counter"></a>');
			    $('#custom_btn_container').append('<a href="#" id="btn2" class="square_btn2">はじめに<br>戻る</a>');
			    $('#custom_btn_container').append('<a href="#" id="btn3" class="square_btn3">新郎新婦へ<br>コメント</a>');
			    
			    // ボタンを押した際の処理
			    $('#btn1').on('click', function(){
			    	countupCounter();
			    });
			    $('#btn2').on('click', function(){
			    	MobiAgentClient.sendMessage('[はじめから]','');
			    });
			    $('#btn3').on('click', function(){
			    	MobiAgentClient.sendMessage('[新郎新婦へのコメント]','');
			    });
				
				getCounter();
			    
			});
			
	};
	
	
		 // 初回小窓オープン時かどうかを判定
    var hasRoom = false; // ルームがすでに存在するかどうか
    var sendMsg = false; // 初回メッセージが送信されたかどうか
    // 小窓画面ロード時に呼ばれるイベント
    MobiAgentClient.on('sdkReady', function(data){
      MobiAgentClient.on('roomReady', function(data){
      	MobiAgentClient.toggle(true);
      });
	    
      // 小窓のみリロードする場合
      if(hasRoom && sendMsg){
      	//showChatWindow()
        hasRoom = false;
        sendMsg = false;
      }
      else {
        //hideChatWindow();
      }
      // セッションが存在した場合
      if (data.hasRoom){
        hasRoom = true;
        sendMsg = false;
      }
    });
		
	
	// チャット小窓のOpen時の処理
	// 初めに１チャット送信しないと、カテゴリ選択が表示されないため
	MobiAgentClient.on('openFrame', function(data2){
		
      	showChatWindow();
      	// 初回Open時に送るメッセージ
      	if(hasRoom == false || (hasRoom == true && sendMsg == false)){
        	MobiAgentClient.sendMessage('お問い合わせ開始','');
        	hasRoom = true;
        	sendMsg = true;
      	}
		 });
		 
		 // チャット小窓のClose時の処理
	MobiAgentClient.on('closeFrame', function(data2){
  		hideChatWindow();
		
		$('#welcome').css({
		    //'visibility': 'visible',
		    'z-index':100000,
		    'opacity': '1.0',
		    'transition' : 'opacity 1s linear 0s'
		});
	});
	
	/*
	$(function(){
      $('#domain-id').val(localStorage.getItem('domain-id'));
      MobiAgentClient.on('sdkReady', function(data){
        MobiAgentClient.on('roomReady', function(data){
          MobiAgentClient.toggle();
        });
        if (!data.hasRoom){
          MobiAgentClient.sendMessage('問い合わせ');
        }
      });
      MobiAgentClient.on('closeChatView', function(data){
        location.reload(true);
      });
    });	*/
    
	function closeRoom(){
	    setTimeout(() => {
	      MobiAgentClient.setReviewThenClose(5, 'ルームクローズ');
	      setTimeout(() => {
	        MobiAgentClient.loadOnceGuard=false;
	        //hideChatWindow();
	        //MobiAgentClient.toggle(false);
	      }, 0)
	    }, 0);
	}
	
	var removeMobiContainer = function(){
		$("#konnect-container").remove();
		$("#custom_btn_container").remove();
		console.log("remove mobi container");
  	};
  	
	var closeSessionAndInitMobi = function(){
		setTimeout(() => {
			closeRoom();
			setTimeout(() => {
				MobiAgentClient.toggle(false);
				removeMobiContainer();
				setTimeout(() => {
					startChat();
				}, 500)
			}, 500)
		}, 0);
	};
	
    
</script>

</body>
</html>